<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Uploaded Image Gallery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .gallery-img {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }
    .card-title {
      font-weight: 500;
      margin-top: 0.5rem;
    }
    .card-container {
      margin-top: 30px;
    }
    #dropzone {
      border: 2px dashed #ccc;
      padding: 30px;
      text-align: center;
      background-color: #f8f9fa;
      transition: background-color 0.3s ease;
    }
    #dropzone.dragover {
      background-color: #e9ecef;
    }
    #preview {
      max-height: 200px;
      margin: 15px 0;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center">üì∏ Uploaded Image Gallery</h2>

  <!-- Upload Form -->
  <div class="text-center mb-4">
    <input type="text" id="titleInput" placeholder="Enter image title" class="form-control mb-2" required>

    <!-- Drag & Drop Area -->
    <div id="dropzone" class="rounded">
      üìÅ Drag & Drop image here or click to browse
      <input type="file" id="fileInput" accept="image/*" class="form-control d-none" required>
    </div>

    <img id="preview" src="#" alt="Preview" class="img-fluid mb-2 d-none"/>

    <button id="uploadBtn" class="btn btn-success mt-2">Upload</button>
  </div>

  <!-- Success/Error Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Gallery Grid -->
  {% if images %}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for image in images %}
    <div class="col">
      <div class="card h-100 shadow-sm">
        <img src="{{ image.file.url }}" class="gallery-img card-img-top" alt="image">
        <div class="card-body text-center">
          <h5 class="card-title">{{ image.title }}</h5>
          <button class="btn btn-danger btn-sm mt-2" onclick="deleteImage('{{ image.id }}')">Delete</button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-center mt-4">No images uploaded yet.</p>
  {% endif %}
</div>

<script>
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const preview = document.getElementById('preview');

  // Click to browse
  dropzone.addEventListener('click', () => fileInput.click());

  // Preview image
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.classList.remove('d-none');
    }
  });

  // Drag over styling
  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
  });

  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    fileInput.files = e.dataTransfer.files;

    const file = fileInput.files[0];
    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.classList.remove('d-none');
    }
  });

  // Upload handler
  uploadBtn.addEventListener('click', async () => {
    const title = document.getElementById('titleInput').value.trim();
    const file = fileInput.files[0];

    if (!title || !file) {
      alert('Please provide both title and file.');
      return;
    }

    const formData = new FormData();
    formData.append('title', title);
    formData.append('file', file);

    const response = await fetch('/gallery/upload/', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    if (result.status === 'success') {
      location.reload();
    } else {
      alert(result.message || 'Upload failed.');
    }
  });

  // Delete handler
  async function deleteImage(id) {
    const response = await fetch(`/gallery/delete/${id}/`, { method: 'POST' });
    const result = await response.json();
    if (result.status === 'success') {
      location.reload();
    } else {
      alert('Failed to delete image.');
    }
  }
</script>

</body>
</html>